@page "/gun-configurator"
@using TarkovDataOrganizer
<h3>Gun Configurator</h3>

@if (IsLoading)
{
    <p>Loading, please wait...</p>
}
else if (ErrorMessage != null)
{
    <p style="color:red">@ErrorMessage</p>
}
else
{
    <select @bind="SelectedCategory">
        @foreach (var category in Categories)
        {
            <option value="@category">@category</option>
        }
    </select>

    <select>
        @foreach (var item in FilteredWeaponNames)
        {
            <option value="@item">@item</option>
        }
    </select>
}

@code {
    private List<string> WeaponNames = new List<string>();
    public string? SelectedCategory { get; set; }
    public List<string> Categories { get; set; } = new();

    private bool IsLoading { get; set; } = true;
    private string? ErrorMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await TarkovData.TarkovItem.DownloadTable();
            Categories = TarkovData.TarkovItem.GetDistinctCategories();

            var csvContent = await File.ReadAllTextAsync(Path.Combine(Environment.CurrentDirectory, "wwwroot", "testReportAllCombos.csv"));
            WeaponNames = ParseCsv(csvContent);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private List<string> ParseCsv(string csvContent)
    {
        var lines = csvContent.Split('\n');
        var itemNames = new List<string>();

        foreach (var line in lines.Skip(1)) // Skip header
        {
            var columns = line.Split(',');
            if (columns.Length > 3) // Ensure there are enough columns
            {
                itemNames.Add(columns[3].Trim());
            }
        }

        return itemNames;
    }

    private IEnumerable<string> FilteredWeaponNames =>
        string.IsNullOrEmpty(SelectedCategory)
            ? WeaponNames.Distinct(StringComparer.OrdinalIgnoreCase)
            : WeaponNames
                .Where(item => item.Contains(SelectedCategory, StringComparison.OrdinalIgnoreCase))
                .Distinct(StringComparer.OrdinalIgnoreCase);
}
